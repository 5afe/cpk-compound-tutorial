# Integrating Gnosis Safe Proxy Kit with the frontend (Compound App Example)
# App can be found live here: https://green-summer.surge.sh/

## Introduction

This tutorial will teach you how you can use Gnosis Safe Contract Proxy Kit to perform batched transactions and interact with smart contracts. 
This tutorial is meant for those with a basic knowledge of Ethereum and Solidity. Furthermore, you should have some basic knowledge in JavaScript.
 
In this Tutorial we will cover: 

- How to install and initialize CPK
- How to interact with the CPK JavaScript library
- How to perform a transaction
- How to interact with a smart contract
- How to use batched transactions

## Background information

Our final project will be a [React](https://reactjs.org) application which allows you to invest DAI into Compound protocol.

## Downloading the template and installing dependencies

**Clone the repository**:

```
git clone https://github.com/gnosis/cpk-compound-tutorial.git
```

**Install the dependencies:**

If you are using [yarn](https://yarnpkg.com/):
```
yarn
```
Or if [npm](https://npmjs.com)
```
npm i
```

## Project structure walk-through

- `src/abis`  

[ABI](https://solidity.readthedocs.io/en/develop/abi-spec.html) for the contracts we'll interact with.

- `src/assets`  

Fonts, icons, images - all these kind of things are stored there

- `src/components`  

React components for our application. That's where we will do the work

- `src/hooks`  

Custom React hooks

- `src/styles`  

All major and app-wide styles go there. Component-related styles are to be placed within the component file

- `src/types`  

TypeScript type definitions

- `src/contracts.ts`  

Here we defined two constants with contract addresses

- `src/index.tsx`  

An entry file for our application

- `src/react-app-env.d.ts`  

Types for the bootstrapped application generated by `create-react-app`

- `src/Root.tsx`  

Root Application component

## Installing and initializing CPK

First, install `contract-proxy-kit` with package manager of your choice:

```
npm i contract-proxy-kit

or

yarn add contract-proxy-kit
```

After user has connected a wallet, we can initialize the CPK instance. The library supports both Web3.js and ethers.js. Our example we'll use Web3.js. In `src/components/App.tsx` on line 56, there's a comment. Replace it with the actual code for initialization:

```jsx
setProxyKit(await CPK.create({ web3 }))
```

There we're calling a method to initialize CPK instance, passing our web3 provider as an option to it and saving it to React's component state. If you're not familiar with React, don't worry, think of it just a place where we can store the instance to reuse later.

## Funding the proxy

All the contract interactions are intended to be performed with the proxy with us only triggering one transaction on proxy contract. Thus, if any value/asset needs to be sent, proxy should own this asset. In our case this is DAI token.

In `src/components/CompoundForm.tsx` on line 81, replace the comment with the following:
```ts
if (cpk.address !== address) {
  const proxyDaiBalance = await dai.methods.balanceOf(cpk.address).call()
  if (proxyDaiBalance < daiAmount) {
    await dai.methods
      .transfer(
        cpk.address,
        (parseInt(daiAmount, 10) - proxyDaiBalance).toString()
      )
      .send({ from: address })
  }
}
```

Here, we check if the contract proxy kit's address is not the same as our user's account because for users connected with the [Safe wallet](https://gnosis-safe.io) CPK features are already built into the Safe contract and thus CPK will reuse user's connected wallet, so we don't need to fund it. If this is not the case, we fund the proxy.

## Using CPK to invest DAI into Compound

First, we need to fund the proxy with the amount of DAI we want to invest:

```jsx
await dai.methods.transfer(cpk.address, daiAmount).send({ from: address })
```

Second, we need to prepare an array of transactions to execute for the Contract Proxy Kit:

```jsx
const txs = [
      {
        operation: CPK.CALL,
        to: DAI_ADDRESS,
        value: 0,
        data: dai.methods.approve(CDAI_ADDRESS, daiAmount).encodeABI()
      },
      {
        operation: CPK.CALL,
        to: CDAI_ADDRESS,
        value: 0,
        data: cDai.methods.mint(daiAmount).encodeABI()
      }
    ]
```

And then we simply execute it by calling `execTransactions` on the CPK instance:

```jsx
await cpk.execTransactions(txs)
```

`execTransactions` will return an object with [promiEvent](https://web3js.readthedocs.io/en/v1.2.5/callbacks-promises-events.html#promievent) property you can use to subscribe for updates.

The source code of the complete example app can be found [here](https://github.com/gnosis/cpk-compound-example)

## Useful links

- [Contract Proxy Kit documentation](https://github.com/gnosis/contract-proxy-kit)
- [Web3.js docs](https://web3js.readthedocs.io/)
- [Source code for the example app](https://github.com/gnosis/cpk-compound-example)
